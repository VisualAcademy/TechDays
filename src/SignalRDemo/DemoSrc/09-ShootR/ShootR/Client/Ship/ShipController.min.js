var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},ShipController=function(n){function t(t,i,r,u,f,e){n.call(this),this.fire=f,this.connection=e,this.TryInterpolate=!0,this.TryInterpolateRotation=!1,this._movementCount=0,this._commandList=[],this._currentCommand=0,this._wasDead=!1,this._keyMapping=[],this._keyMapping.push({key:t,dir:"RotatingLeft"}),this._keyMapping.push({key:r,dir:"RotatingRight"}),this._keyMapping.push({key:i,dir:"Forward"}),this._keyMapping.push({key:u,dir:"Backward"}),this.LifeController.Health=this.MaxLife,this.MovementController.Smoothing={X:!1,Y:!1},this.MovementController.Target=Vector2.Zero(),this.MovementController.InterpolateOver=Vector2.Zero(),this.MovementController.InterpolateRotationOver=0,this.MovementController.SmoothingRotation=!1,this.MovementController.TargetRotation=0}return __extends(t,n),t.REQUEST_PING_EVERY=5,t.DOUBLE_TAP_AFTER=175,t.prototype.registerPayload=function(){var n=(new Date).getTime();this._lastPayloadReceivedAt&&(this._payloadsEvery=n-this._lastPayloadReceivedAt),this._lastPayloadReceivedAt=n},t.prototype.checkInterpolation=function(n,t,i){i[t]>ShipMovementController.INTERPOLATE_POSITION_THRESHOLD&&(this.MovementController.InterpolateOver[t]=Math.max(this._payloadsEvery,50),this.MovementController.Smoothing[t]=!0,this.MovementController.Target[t]=n.MovementController.Position[t],n.MovementController.Position[t]=this.MovementController.Position[t])},t.prototype.checkRotationInterpolation=function(n){var t=Math.abs(this.MovementController.Rotation-n.MovementController.Rotation);t>ShipMovementController.INTERPOLATE_ROTATION_THRESHOLD&&(this.MovementController.InterpolateRotationOver=Math.max(this._payloadsEvery,35),this.MovementController.SmoothingRotation=!0,this.MovementController.TargetRotation=n.MovementController.Rotation,n.MovementController.Rotation=this.MovementController.Rotation)},t.prototype.determineInterpolation=function(t){if(this._payloadsEvery){if(this.LifeController.Alive||(this.MovementController.Smoothing.X=!1,this.MovementController.Smoothing.Y=!1,this._wasDead=!0),!this._wasDead){if(this.TryInterpolate){n.prototype.Update.call(this,null);var i=CalculateDistance(this.MovementController.Position,t.MovementController.Position);this.checkInterpolation(t,"X",i),this.checkInterpolation(t,"Y",i)}this.TryInterpolateRotation&&this.checkRotationInterpolation(t)}this.LifeController.Alive&&(this._wasDead=!1)}},t.prototype.doubleTap=function(n){return n==="Forward"?(this.startAbility("Boost"),!0):!1},t.prototype.startAbility=function(n){this.Controllable.Value&&this.ShipAbilityHandler.Activate(n)&&this.LifeController.Alive&&(this._commandList.push([++this._currentCommand,n,!0,!0]),this.connection.server.registerAbilityStart(n,!1,this._currentCommand),this.UpdateFromSecond(CalculatePOS(this.LastUpdated)))},t.prototype.stopAbility=function(n){if(this.Controllable.Value&&this.ShipAbilityHandler.Deactivate(n)&&this.LifeController.Alive)this._commandList.push([++this._currentCommand,n,!1,!0]),this.connection.server.registerAbilityStop(n,!1,this._currentCommand),this.UpdateFromSecond(CalculatePOS(this.LastUpdated))},t.prototype.startMovement=function(n){var i,r,u;this.Controllable.Value&&!this.MovementController.Moving[n]&&this.LifeController.Alive&&(i=!1,r=(new Date).getTime(),this._movementCount=++this._movementCount%t.REQUEST_PING_EVERY,this._movementCount===0&&(i=!0,this.LatencyResolver.RequestedPingBack()),u=!1,r-this._lastCommandStartAt<=t.DOUBLE_TAP_AFTER&&this._lastCommandStart===n&&(u=this.doubleTap(n)),u||(this._lastCommandStartAt=r,this._lastCommandStart=n,this._commandList.push([++this._currentCommand,n,!0]),this.connection.server.registerMoveStart(n,i,this._currentCommand),this.UpdateFromSecond(CalculatePOS(this.LastUpdated))),this.MovementController.Moving[n]=!0)},t.prototype.stopMovement=function(n){if(this.Controllable.Value&&this.LifeController.Alive){var i=!1;this._movementCount=++this._movementCount%t.REQUEST_PING_EVERY,this._movementCount===0&&(i=!0,this.LatencyResolver.RequestedPingBack()),this._commandList.push([++this._currentCommand,n,!1]),this.connection.server.registerMoveStop(n,i,this._currentCommand),this.UpdateFromSecond(CalculatePOS(this.LastUpdated)),this.MovementController.Moving[n]=!1}},t.prototype.stopAndStartMovement=function(n,i){var r,u,f;this.Controllable.Value&&this.LifeController.Alive&&(r=!1,u=(new Date).getTime(),this._movementCount=++this._movementCount%t.REQUEST_PING_EVERY,this._movementCount===0&&(r=!0,this.LatencyResolver.RequestedPingBack()),f=!1,u-this._lastCommandStartAt<=t.DOUBLE_TAP_AFTER&&this._lastCommandStart===i&&(f=this.doubleTap(i)),f||(this._lastCommandStartAt=u,this._lastCommandStart=i,this._commandList.push([++this._currentCommand,n,!1]),this._commandList.push([++this._currentCommand,i,!0]),this.connection.server.startAndStopMovement(n,i,r,this._currentCommand),this.UpdateFromSecond(CalculatePOS(this.LastUpdated)),this.MovementController.Moving[n]=!1,this.MovementController.Moving[i]=!0))},t.prototype.resetMovement=function(n){var r,i;if(this.Controllable.Value&&this.LifeController.Alive){for(r=!1,this._movementCount=++this._movementCount%t.REQUEST_PING_EVERY,this._movementCount===0&&(r=!0),this.UpdateFromSecond(CalculatePOS(this.LastUpdated)),i=0;i<n.length;i++)this.MovementController.Moving[n[i]]=!1,this._commandList.push([++this._currentCommand,n[i],!1]);this.connection.server.resetMovement(n,r,this._currentCommand)}},t.prototype.shoot=function(n){var t=n-this._lastShot;this.Controllable.Value&&t>Ship.MIN_FIRE_RATE&&(this._lastShot=n,this.connection.server.fire())},t.prototype.applyKeyboardMappings=function(){for(var u,r=!0,f,n=this,i,t=0;t<this._keyMapping.length;t++)for(i=0;i<this._keyMapping[t].key.length;i++)shortcut.add(n._keyMapping[t].key[i],function(t){return function(){n.startMovement(n._keyMapping[t].dir)}}(t),{disable_in_input:!0,type:"keydown"}),shortcut.add(n._keyMapping[t].key[i],function(t){return function(){n.stopMovement(n._keyMapping[t].dir)}}(t),{disable_in_input:!0,type:"keyup"});shortcut.add(this.fire,function(){u=(new Date).getTime(),r?(n.shoot(u),f=setTimeout(function(){r=!1,n.connection.server.startFire()},Ship.MIN_FIRE_RATE)):n.connection.server.startFire()},{disable_in_input:!0,type:"keydown"}),shortcut.add(this.fire,function(){var t;clearTimeout(f),t=(new Date).getTime(),r||(n._lastShot=t,n.connection.server.stopFire()),r=t-u<Ship.MIN_FIRE_RATE},{disable_in_input:!0,type:"keyup"}),$(window).blur(function(){n.resetMovement(["Forward","Backward","RotatingLeft","RotatingRight"]),n.connection.server.stopFire()})},t.prototype.PayloadReceived=function(n){this.registerPayload();for(var t=0;t<n.Ships.length;t++)if(this.ID===n.Ships[t].ID){this.determineInterpolation(n.Ships[t]);break}},t.prototype.ReplayCommands=function(n){var i,t;if(this._commandList.length>=1){for(i=this._commandList.length-(this._currentCommand-n),t=i;t<this._commandList.length;t++)this._commandList[t][3]?this._commandList[t][2]?this.ShipAbilityHandler.Activate(this._commandList[t][1]):this.ShipAbilityHandler.Deactivate(this._commandList[t][1]):this.MovementController.Moving[this._commandList[t][1]]=this._commandList[t][2];this._commandList.splice(0,i)}},t.prototype.Initialize=function(n){("createTouch"in document||navigator.msMaxTouchPoints)&&(this._touchController=new TouchController(this.startMovement,this.stopMovement,this.stopAndStartMovement,this.resetMovement,this.shoot),this._touchController.Initialize(n)),this.applyKeyboardMappings()},t.prototype.DrawHUD=function(){this._touchController&&this._touchController.Draw()},t.prototype.ResetTouchController=function(){this._touchController&&this._touchController.Reset()},t}(Ship)