function ValueRef(n){var t=this;t.Value=n};var IMAGE_ASSETS={INIT:function(){this.Explosion.src="Images/SpriteSheets/explosion_1.png",this.Laser.src="/Images/Laser.png",this.BigExplosion.src="/Images/SpriteSheets/explosion_2.png",this.Ship1.src="/Images/Ships/ship_lvl1.png",this.Ship2=this.Ship1,this.Ship3.src="/Images/Ships/ship_lvl3.png",this.Ship4=this.Ship3,this.Ship5.src="/Images/Ships/ship_lvl5.png",this.Ship6=this.Ship5,this.Ship7.src="/Images/Ships/ship_lvl7.png",this.Ship8.src="/Images/Ships/ship_lvl8.png",this.Ship9.src="/Images/Ships/ship_lvl9.png",this.Ship10.src="/Images/Ships/ship_lvl10.png",this.ThrustBasic.src="/Images/SpriteSheets/thrust_basic.png",this.HealthPack.src="/Images/SpriteSheets/health_pack.png",this.Boost.src="/Images/SpriteSheets/thrusters-BOOST.png",this.ThrustStart.src="/Images/SpriteSheets/thrust_start.png",this.ShipDamage1.src="/Images/Ships/Damage/damage_1.png",this.ShipDamage3.src="/Images/Ships/Damage/damage_2.png",this.ShipDamage5.src="/Images/Ships/Damage/damage_3.png",this.ShipDamage7.src="/Images/Ships/Damage/damage_4.png",this.LaserCatBomb.src="/Images/Ships/LaserCat.png"},Explosion:new Image,Laser:new Image,BigExplosion:new Image,Ship1:new Image,Ship3:new Image,Ship5:new Image,Ship7:new Image,Ship8:new Image,Ship9:new Image,Ship10:new Image,ShipDamage1:new Image,ShipDamage3:new Image,ShipDamage5:new Image,ShipDamage7:new Image,ThrustBasic:new Image,HealthPack:new Image,Boost:new Image,ThrustStart:new Image,LaserCatBomb:new Image};IMAGE_ASSETS.INIT();var Vector2=function(){function n(n,t){if(isNaN(n)||t!==!1)this.X=n||0,this.Y=t||0;else{var i=n*Math.PI/180;this.X=Math.cos(i),this.Y=Math.sin(i)}}return n.prototype.Length=function(){return Math.sqrt(Math.pow(this.X,2)+Math.pow(this.Y,2))},n.prototype.Abs=function(){return new n(Math.abs(this.X),Math.abs(this.Y))},n.prototype.DistanceTo=function(n){return Math.sqrt(Math.pow(n.X-this.X,2)+Math.pow(n.Y-this.Y,2))},n.prototype.ZeroOut=function(){this.X=0,this.Y=0},n.MultiplyV=function(t,i){return new n(t.X*i.X,t.Y*i.Y)},n.MultiplyN=function(t,i){return new n(t.X*i,t.Y*i)},n.AddV=function(t,i){return new n(t.X+i.X,t.Y+i.Y)},n.AddN=function(t,i){return new n(t.X+i,t.Y+i)},n.SubtractV=function(t,i){return new n(t.X-i.X,t.Y-i.Y)},n.SubtractVFromN=function(t,i){return new n(t.X-i,t.Y-i)},n.SubtractNFromV=function(t,i){return new n(t-i.X,t-i.Y)},n.DivideV=function(t,i){return new n(t.X/i.X,t.Y/i.Y)},n.DivideVByN=function(t,i){return new n(t.X/i,t.Y/i)},n.DivideNByV=function(t,i){return new n(t/i.X,t/i.Y)},n}();function GameTime(){var n=this,t=new Date;n.PercentOfSecond=0,n.Now=new Date,n.Update=function(){n.PercentOfSecond=CalculatePOS(t),n.Now=new Date,t=n.Now}};function AnimationManager(){var n=this,t=[],i=0;n.Add=function(n){t.push(n),i++},n.Remove=function(n){t.splice(n,1),i--},n.Update=function(){for(var u=0;u<i;u++)t[u].Destroyed?n.Remove(u--):t[u].Draw()}};function Screen(n,t,i,r){function s(){n.attr("width",u.Viewport.Width),n.attr("height",u.Viewport.Height),t.css("width",u.Viewport.Width),t.css("height",u.Viewport.Height),i&&(i.css("width",u.Viewport.Width),i.css("height",u.Viewport.Height))}function h(){CanvasContext.Camera.View.WIDTH=$(n).width()+u.SCREEN_BUFFER_AREA,CanvasContext.Camera.View.HEIGHT=$(n).height()+u.SCREEN_BUFFER_AREA}function e(){u.Viewport=u.UpdateViewport(),s(),h(),CanvasContext.UpdateSize(u.Viewport),u.SendNewViewportToServer(),f&&f.OnScreenResize(u.Viewport),$(u).triggerHandler("UpdateScreen")}function o(){e(),setTimeout(e,1500)}var u=this,f;u.SCREEN_BUFFER_AREA,Screen.prototype.MAX_SCREEN_WIDTH=1e4,Screen.prototype.MAX_SCREEN_HEIGHT=1e4,Screen.prototype.MIN_SCREEN_WIDTH=-1,Screen.prototype.MIN_SCREEN_HEIGHT=-1,u.Initialize=function(n){f=n,o()},u.TopOffset=function(){return 0},u.BottomOffset=function(){return 0},u.UpdateViewport=function(){return{Width:Math.max(Math.min($(window).width(),u.MAX_SCREEN_WIDTH),u.MIN_SCREEN_WIDTH),Height:Math.max(Math.min($(window).height(),u.MAX_SCREEN_HEIGHT)-u.TopOffset()-u.BottomOffset(),u.MIN_SCREEN_HEIGHT)}},u.Viewport=u.UpdateViewport(),u.SendNewViewportToServer=function(){r.server.changeViewport(u.Viewport.Width,u.Viewport.Height)},$(window).resize(function(){delay(function(){o()},250)})};var AreaRenderer=function(){function n(n,t){this.AREA_BOX_COLOR="#304665",this.AREA_TEXT_COLOR="#3fa9f5",this.AREA_TEXT_MARGIN=13,this.KEYBOARD_MAPPING="m",this._showMap=!0,this._areaLetters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],this._hudArea=$("#Area"),this.OnMapResize(t),this._myShip=n,this.ApplyKeyboardMappings()}return n.prototype.ApplyKeyboardMappings=function(){var n=this;shortcut.add(this.KEYBOARD_MAPPING,function(){n._showMap=!n._showMap})},n.prototype.DrawSectorMap=function(n,t,i){for(var u=this.GetBoxPositions(n,t,i),r=u.length-1;r>=0;r--)this.DrawAreaBox(u[r])},n.prototype.DrawAreaBox=function(n){CanvasContext.strokeSquare(n.Position.X,n.Position.Y,this._areaSize,this._areaSize,this.AREA_BOX_COLOR),CanvasContext.drawText(n.Sector,n.Position.X+this.AREA_TEXT_MARGIN,n.Position.Y+this.AREA_TEXT_MARGIN,this.AREA_TEXT_COLOR,!1,"start","top"),CanvasContext.drawText(n.Sector,n.Position.X+this.AREA_TEXT_MARGIN,n.Position.Y+this._areaSize-this.AREA_TEXT_MARGIN,this.AREA_TEXT_COLOR,!1,"start","bottom"),CanvasContext.drawText(n.Sector,n.Position.X+this._areaSize-this.AREA_TEXT_MARGIN,n.Position.Y+this.AREA_TEXT_MARGIN,this.AREA_TEXT_COLOR,!1,"end","top"),CanvasContext.drawText(n.Sector,n.Position.X+this._areaSize-this.AREA_TEXT_MARGIN,n.Position.Y+this._areaSize-this.AREA_TEXT_MARGIN,this.AREA_TEXT_COLOR,!1,"end","bottom")},n.prototype.GetBoxPosition=function(n){return new Vector2(Math.ceil(n%3),Math.floor(n/3))},n.prototype.GetBoxPositions=function(n,t,i){var e=[],s=Vector2.SubtractVFromN(n,this._areaSize),h=this,o,u,f,r;for(e.push({Position:n,Sector:h._areaLetters[t--]+i--}),o={MovementController:{Position:s},WIDTH:this._areaSize,HEIGHT:this._areaSize},u=0;u<9;u++)u!==4&&(f=this.GetBoxPosition(u),r=Vector2.MultiplyN(f,this._areaSize),r=Vector2.AddV(r,s),r.X>=0&&r.Y>=0&&r.X+this._areaSize<=this._mapSize&&r.Y+this._areaSize<=this._mapSize&&(o.MovementController.Position=r,CanvasContext.Camera.InView(o)&&e.push({Position:r,Sector:h._areaLetters[t+f.X]+(i+f.Y)})));return e},n.prototype.OnMapResize=function(n){this._mapSize=n,this._areaSize=Math.max(Math.round(this._mapSize/this._areaLetters.length),1e3)},n.prototype.Draw=function(){var n=Math.max(Math.floor(this._myShip.MovementController.Position.X/this._areaSize),0),i=this._areaLetters[n],t=Math.max(Math.ceil(this._myShip.MovementController.Position.Y/this._areaSize),1),r=new Vector2(n*this._areaSize,(t-1)*this._areaSize);this._showMap&&this.DrawSectorMap(r,n,t),this._hudArea.html(i+t)},n.prototype.Update=function(){this.Draw()},n}();var GAME_GLOBALS={AnimationManager:new AnimationManager,Colors:{ShipBad:"#ED1E79",ShipHurt:"#FF931E",ShipGood:"#7AC943"}};function LatencyResolver(n){function o(n,i){var r=+new Date,u=t.CalculateLatencySince(n);return r-i+u}function e(n,t){i.push(o(n,t))}var t=this,f=0,i=[],u=new ClientServerTime,r=!1;t.SampleSize=10,t.Latency="...",t.RequestedPingBack=function(){r||(r=+new Date)},t.ServerPingBack=function(){r&&(t.Latency=t.CalculateLatencySince(r)+" ms",r=!1)},t.ResolveFromAcknowledgement=function(n,r){e(n,r),i.length===t.SampleSize&&(u.Delta=t.GenerateDeltaTime(),i=[])},t.CalculateLatencySince=function(n){return(+new Date-n)/2},t.Resolve=function(r){function o(){var s=+new Date;n.server.ping().done(function(n){e(s,u.GetServerTime(+new Date(n))),++f<t.SampleSize?o():f===1?u.Delta=i[0]:(u.Delta=t.GenerateDeltaTime(),i=[],r())})}i=[],n.server.ping().done(o)},t.GenerateDeltaTime=function(){var r,t,n;for(i.sort(),r=StandardDeviation(i),t=i[Math.floor(i.length/2)],n=0;n<i.length;n++)Math.abs(i[n]-t)>=r&&i.splice(n--,1);return Math.round(Average(i))}};function CalculatePO(n,t){var i=new Date;return i.setTime(i-n),i.getTime()/t}function CalculatePOS(n){return CalculatePO(n,1e3)}function CalculateLength(n,t){return Math.sqrt(Math.pow(n.X-t.X,2)+Math.pow(n.Y-t.Y,2))}function CalculateDistance(n,t){return{X:Math.abs(t.X-n.X),Y:Math.abs(t.Y-n.Y)}}function CalculateAngle(n,t){var r=SubtractVectors(t,n),i=Math.atan2(r.Y,r.X)*-180/Math.PI;return i<0&&(i+=360),i}function StandardDeviation(n){for(var u=Average(n),i=n.length,r=0,t=0;t<i;t++)r+=Math.pow(n[t]-u,2);return Math.sqrt(r/(i-1))}function Average(n){for(var i=0,r=n.length,t=0;t<r;t++)i+=n[t];return i/r}function HeightOffset(n){return $(n).height()+parseInt($(n).css("margin-top"))+parseInt($(n).css("margin-bottom"))}function SubtractVectors(n,t){return{X:t.X-n.X,Y:t.Y-n.Y}}var delay=function(){var n=0;return function(t,i){clearTimeout(n),n=setTimeout(t,i)}}();jQuery.fn.flash=function(n,t){this.stop(!0);var i=this.css("backgroundColor");this.animate({backgroundColor:"rgb("+n+")"},t/2).animate({backgroundColor:i},t/2)};function JoyStick(n,t,i,r,u,f){function h(){var f,r,h,c,u,i,s;if(e.Traveled()>n){for(o=!0,f=SubtractVectors(e.PositionStart,e.Position),r=Math.atan2(f.Y,f.X)*-180/Math.PI,r<0&&(r+=360),u=!1,i=0;i<t.length;i++)s=t[i].ValidMove(r),!s&&t[i].Active?(u=!0,h=t[i]):s&&!t[i].Active&&(u=!0,c=t[i]);return{changed:u,toStart:c,toStop:h}}return!1}function c(n,t){(n||t)&&(n&&t?(n.Active=!1,t.Active=!0,u(n.Direction,t.Direction)):n?(n.Active=!1,r(n.Direction)):t&&(t.Active=!0,i(t.Direction)))}function s(){var i,n;if(o){for(o=!1,i=[],n=0;n<t.length;n++)t[n].Active=!1,i.push(t[n].Direction);f(i)}}var e=this,o=!1;e.touchID=!1,e.PositionStart={X:0,Y:0},e.Position={X:0,Y:0},e.InAction=!1,e.InActionAt=!1,e.TimeSinceTouch=function(){return e.InActionAt?+new Date-e.InActionAt:!1},e.Traveled=function(){return CalculateLength(e.Position,e.PositionStart)},e.TouchStart=function(n){e.touchID===!1&&(e.InActionAt=+new Date,e.InAction=!0,e.PositionStart.X=n.clientX,e.PositionStart.Y=n.clientY,e.touchID=n.identifier,e.Position=$.extend({},e.PositionStart))},e.TouchMove=function(n){if(e.touchID===n.identifier){e.Position.X=n.clientX,e.Position.Y=n.clientY;var t=h();return t?t.changed&&c(t.toStop,t.toStart):s(),!0}return!1},e.TouchStop=function(n){return e.touchID===n.identifier?(e.InAction=!1,e.touchID=!1,e.InActionAt=!1,s(),!0):!1},e.Draw=function(){e.InAction&&(e.TimeSinceTouch()>1e3||e.Traveled()>=n)&&(CanvasContext.drawCircle(e.PositionStart.X,e.PositionStart.Y,40,5,"#1BFF27"),CanvasContext.drawCircle(e.PositionStart.X,e.PositionStart.Y,60,2,"#1BFF27"),CanvasContext.drawCircle(e.Position.X,e.Position.Y,40,2,"#2EBD15"),CanvasContext.drawLine(e.PositionStart.X,e.PositionStart.Y,e.Position.X,e.Position.Y,2,"#4A993C"))}};function IETouchAdapter(n,t,i){function u(n){n.preventDefault();var t=n;return t.identifier=n.pointerId,t}var r=this;r.Start=function(t){n(u(t))},r.Move=function(n){t(u(n))},r.Stop=function(n){i(u(n))}};function MouseAdapter(n,t,i){var r=this,f=0,u=0;r.Start=function(t){t.preventDefault();var i=t;t.identifier=u=f++,n(t)},r.Move=function(n){n.preventDefault();var i=n;n.identifier=u,t(n)},r.Stop=function(n){n.preventDefault();var t=n;n.identifier=u,i(n)}};function TouchAdapter(n,t,i){var r=this;r.Start=function(t){var i,r;for(t.preventDefault(),i=0;i<t.changedTouches.length;i++)r=t.changedTouches[i],n(r)},r.Move=function(n){var i,r;for(n.preventDefault(),i=0;i<n.changedTouches.length;i++)r=n.changedTouches[i],t(r)},r.Stop=function(n){var t,r;for(n.preventDefault(),t=0;t<n.changedTouches.length;t++)r=n.changedTouches[t],i(r)}};function Movement(n,t,i,r){var u=this;u.ValidMove=function(i){return r?i>=t||i<=n&&i>=0:i>=n&&i<=t},u.Direction=i,u.Active=!1}function TouchController(n,t,i,r,u){function p(n){s.Enabled&&(n.clientX<=middle?o.InAction||o.TouchStart(n):e.InAction||e.TouchStart(n))}function y(n){s.Enabled&&(o.TouchMove(n),e.TouchMove(n))}function l(n){s.Enabled&&((o.InAction&&o.Traveled()<a&&o.TimeSinceTouch()<=1e3||e.InAction&&e.Traveled()<a&&e.TimeSinceTouch()<=1e3)&&(h={X:n.clientX,Y:n.clientY},c=+new Date,u(c)),o.TouchStop(n),e.TouchStop(n))}var s=this,f=document.getElementById("game"),h=!1,c=!1,a=22,g=100,tt=new Movement(20,160,"Forward"),d=new Movement(200,340,"Backward"),k=new Movement(125,235,"RotatingLeft"),nt=new Movement(55,305,"RotatingRight",!0),o=new JoyStick(a,[tt,d],n,t,i,r),e=new JoyStick(a,[k,nt],n,t,i,r);s.Enabled=!0;var v=new MouseAdapter(p,y,l),b=new TouchAdapter(p,y,l),w=new IETouchAdapter(p,y,l);s.Reset=function(){l({identifier:o.touchID}),l({identifier:e.touchID})},s.Initialize=function(n){navigator.msPointerEnabled?($(f).css("-ms-touch-action","none"),f.addEventListener("MSPointerDown",w.Start,!1),f.addEventListener("MSPointerMove",w.Move,!1),f.addEventListener("MSPointerUp",w.Stop,!1),f.addEventListener("MSPointerCancel",function(n){n.preventDefault()},!1),f.addEventListener("MSGestureInit",function(n){n.preventManipulation&&n.preventManipulation()},!1),f.addEventListener("MSHoldVisual",function(n){n.preventDefault()},!1)):"createTouch"in document?(f.addEventListener("touchstart",b.Start,!1),f.addEventListener("touchmove",b.Move,!1),f.addEventListener("touchend",b.Stop,!1)):(f.addEventListener("mousedown",v.Start,!1),f.addEventListener("mousemove",v.Move,!1),f.addEventListener("mouseup",v.Stop,!1)),middle=n.Viewport.Width/2;$(n).on("UpdateScreen",function(){middle=n.Viewport.Width/2})},s.Draw=function(){o.Draw(),e.Draw(),c!==!1&&(+new Date-c>=g?(c=!1,h=!1):(CanvasContext.drawCircle(h.X,h.Y,40,6,"#FA6400"),CanvasContext.drawCircle(h.X,h.Y,50,2,"#FA6400")))}};function ClientServerTime(){var n=this;n.Delta=0,n.GetServerTime=function(t){return t+n.Delta},n.ToServerTime=function(t){return t-n.Delta}};function Map(){function t(t,i,r){return t.X>=0&&t.X+i<=n.WIDTH&&t.Y>=0&&t.Y+r<=n.HEIGHT}var n=this;n.WIDTH,n.HEIGHT,n.CheckBoundaryCollisions=function(i,r){var f,u;for(u in i)t(i[u].MovementController.Position,i[u].WIDTH,i[u].HEIGHT)||($(i[u]).triggerHandler("OnOutOfBounds"),i[u].MovementController.Position.X<0||i[u].MovementController.Position.X+i[u].WIDTH>n.WIDTH?f=new Vector2(-n.BARRIER_DEPRECATION,n.BARRIER_DEPRECATION):(i[u].MovementController.Position.Y<0||i[u].MovementController.Position.Y+i[u].HEIGHT>n.HEIGHT)&&(f=new Vector2(n.BARRIER_DEPRECATION,-n.BARRIER_DEPRECATION)),i[u].MovementController.RepositionInBounds(i[u].WIDTH,i[u].HEIGHT),i[u].MovementController.Forces=Vector2.MultiplyV(i[u].MovementController.Forces,f),i[u].MovementController.Velocity=Vector2.MultiplyV(i[u].MovementController.Velocity,f));for(u in r)t(r[u].MovementController.Position,r[u].WIDTH,r[u].HEIGHT)||(r[u].Visible=!1,r[u].MovementController.Velocity.X=0,r[u].MovementController.Velocity.Y=0)},n.Draw=function(){CanvasContext.drawMapBoundary(n.WIDTH,n.HEIGHT)}};function Camera(){var n=this,t=$("#gameWrapper");n.Position={X:0,Y:0},n.View={},n.Move=function(i){n.Position=i,t.css("background-position",-i.X+"px "+-i.Y+"px")},n.Follow=function(t){n.Following=t.ID},n.InView=function(t){var r={WIDTH:t.WIDTH/2,HEIGHT:t.HEIGHT/2},u={X:t.MovementController.Position.X+r.WIDTH,Y:t.MovementController.Position.Y+r.HEIGHT},i={X:n.Position.X-n.View.WIDTH/2-r.WIDTH,Y:n.Position.Y-n.View.HEIGHT/2-r.HEIGHT,WIDTH:n.View.WIDTH+t.WIDTH,HEIGHT:n.View.HEIGHT+t.HEIGHT};return i.X<=u.X&&i.X+i.WIDTH>=u.X&&i.Y<=u.Y&&i.Y+i.HEIGHT>=u.Y},n.Update=function(){}};function CanvasRenderer(n){var t=this,u=n[0].getContext("2d"),r=document.createElement("canvas"),i=r.getContext("2d"),e="15px SegoeUISemibold",o="rgba(255, 255, 255, 1)",f=Math.PI/180;t.UpdateSize=function(n){t.CanvasSize=n,t.CanvasCenter={X:.5*t.CanvasSize.Width,Y:.5*t.CanvasSize.Height},r.width=t.CanvasSize.Width,r.height=t.CanvasSize.Height},t.CanvasSize,t.CanvasCenter,t.Camera=new Camera,t.drawMapBoundary=function(n,r){var u={X:-t.Camera.Position.X+t.CanvasCenter.X,Y:-t.Camera.Position.Y+t.CanvasCenter.Y};i.save(),i.translate(u.X,u.Y),i.lineWidth="5",i.strokeStyle="#3fa9f5",i.strokeRect(0,0,n,r),i.restore()},t.strokeSquare=function(n,r,u,f,e){var o={X:n-t.Camera.Position.X+t.CanvasCenter.X,Y:r-t.Camera.Position.Y+t.CanvasCenter.Y};i.save(),i.translate(o.X,o.Y),i.lineWidth="1",e||(e="#f00"),i.strokeStyle=e,i.strokeRect(0,0,u,f),i.restore()},t.drawRectangle=function(n,r,u,f,e){var o={X:n-t.Camera.Position.X+t.CanvasCenter.X,Y:r-t.Camera.Position.Y+t.CanvasCenter.Y};i.save(),i.translate(o.X,o.Y),i.fillStyle=e,i.fillRect(0,0,u,f),i.restore()},t.drawCircle=function(n,t,r,u,f){i.beginPath(),i.strokeStyle=f,i.lineWidth=u,i.arc(n,t,r,0,Math.PI*2,!0),i.stroke()},t.drawLine=function(n,t,r,u,f,e){i.save(),i.beginPath(),i.strokeStyle=e,i.lineWidth=f,i.moveTo(n,t),i.lineTo(r,u),i.stroke(),i.restore()},t.drawText=function(n,r,u,f,s,h,c){var l={X:-t.Camera.Position.X+t.CanvasCenter.X,Y:-t.Camera.Position.Y+t.CanvasCenter.Y};f||(f=o),s||(s=e),i.save(),i.translate(l.X+r,u+l.Y),h||(h="center"),i.textAlign=h,c&&(i.textBaseline=c),i.font=s,i.fillStyle=f,i.fillText(n,0,0),i.restore()},t.drawRotatedImage=function(n,r,u,e,o,s,h,c,l,a){t!==this&&this.GUID&&this.GUID===t.Camera.Following&&t.Camera.Move({X:this.MovementController.Position.X+this.WIDTH*.5,Y:this.MovementController.Position.Y+this.HEIGHT*.5}),i.save();var v,y={X:-t.Camera.Position.X+t.CanvasCenter.X,Y:-t.Camera.Position.Y+t.CanvasCenter.Y};o?(v={width:l*.5,height:a*.5},i.translate(h+v.width+y.X,c+v.height+y.Y),i.rotate(r*f),i.drawImage(n,u,e,o,s,-v.width,-v.height,l,a)):(v={width:n.width*.5,height:n.height*.5},i.translate(u+v.width+y.X,e+v.height-t.Camera.Position.Y+t.CanvasCenter.Y),i.rotate(r*f),i.drawImage(n,-v.width,-v.height)),i.restore()},t.clear=function(){i.clearRect(0,0,t.CanvasSize.Width,t.CanvasSize.Height)},t.Render=function(){u.clearRect(0,0,t.CanvasSize.Width,t.CanvasSize.Height),u.drawImage(r,0,0)}}var CanvasContext=new CanvasRenderer($("#game"));var Collidable=function(){var n=this,t={X:0,Y:0};n.AnimationDrawList=[],n.Visible=!0,n.LastUpdated=new Date,n.Vehicle,n.FollowID,n.AnimationCanvas,n.AnimationCanvasContext,n.Controllable=new ValueRef(!0),n.InitializeAnimationCanvas=function(){n.AnimationCanvas=document.createElement("canvas"),n.AnimationCanvasContext=n.AnimationCanvas.getContext("2d")},n.UpdateProperties=function(t){for(var i in t)n[i]=t[i]},n.UpdateAnimationCanvasSize=function(i){n.AnimationCanvas.width=i.Width,n.AnimationCanvas.height=i.Height,t.X=(n.WIDTH-i.Width)/2,t.Y=(n.HEIGHT-i.Height)/2},n.Draw=function(){if(n.LifeController.Alive&&n.Visible&&(n.Vehicle&&CanvasContext.drawRotatedImage.apply(n,[n.Vehicle,n.MovementController.Rotation,n.MovementController.Position.X,n.MovementController.Position.Y]),n.AnimationCanvas)){for(var i=n.AnimationDrawList.length-1;i>=0;i--)n.AnimationDrawList[i].Draw();CanvasContext.drawRotatedImage.apply(n,[n.AnimationCanvas,n.MovementController.Rotation,n.MovementController.Position.X+t.X,n.MovementController.Position.Y+t.Y])}}};function MovementController(n,t,i){if(n){var r=this;r.Mass,r.Power,r.Position,r.Velocity=new Vector2,r.Forces=new Vector2,r.Rotation=0,r.LastUpdated=new Date,u(),r.ApplyForce=function(n){r.Forces=Vector2.AddV(r.Forces,n)},r.RepositionInBounds=function(n,t){r.Position.X<0?r.Position.X=0:r.Position.X+n>Map.prototype.WIDTH&&(r.Position.X=Map.prototype.WIDTH-n),r.Position.Y<0?r.Position.Y=0:r.Position.Y+t>Map.prototype.HEIGHT&&(r.Position.Y=Map.prototype.HEIGHT-t)};function u(){n instanceof Vector2?(r.Position=n,r.Mass=t,r.Power=i):(r.Mass=n,r.Power=t)}}};function Powerup(n){Collidable.call(this);var t=this;t.UpdateProperties(n),t.Update=function(){},t.Destroy=function(){t.Visible=!1}}Powerup.prototype=new Collidable;function HealthPack(n){Powerup.apply(this,[n]);var t=this,i,r=+new Date;t.InitializeAnimationCanvas(),t.UpdateAnimationCanvasSize({Width:t.WIDTH,Height:t.HEIGHT}),i=new spritify({image:IMAGE_ASSETS.HealthPack,drawOn:t.AnimationCanvasContext,X:0,Y:0,frameCount:18,fps:18,spriteSheetSize:{width:450,height:100},frameSize:{width:t.WIDTH,height:t.HEIGHT},Rotation:0,autoPlay:!1,loop:!0}),i.Play(),t.AnimationDrawList.push(i),t.Update=function(n){n.Now.getTime()-r>=t.LIFE_SPAN&&(t.Disposed=!0),i.Update(n.Now)}}HealthPack.prototype=new Powerup;function PowerupManager(){var n=this;n.Powerups={},n.UpdatePowerups=function(t,i){for(var e=t.length,u,r,f=0;f<e;f++)u=t[f],r=u.ID,n.Powerups[r]?n.Powerups[r].UpdateProperties(u):u.Type===1&&(n.Powerups[r]=new HealthPack(u)),n.Powerups[r].Disposed?(n.Powerups[r].Destroy(),delete n.Powerups[r]):(n.Powerups[r].Update(i),n.Powerups[r].Draw())},n.Update=function(t){for(var i in n.Powerups)CanvasContext.Camera.InView(n.Powerups[i])&&!n.Powerups[i].Disposed?(n.Powerups[i].Update(t),n.Powerups[i].Draw()):(n.Powerups[i].Destroy(),delete n.Powerups[i])}};var Bullet=function(n){Collidable.call(this);var t=this,i=+new Date;t.Visible=!0,t.Vehicle=IMAGE_ASSETS.Laser,t.ShouldDispose=function(){return+new Date-i>=t.BULLET_DIE_AFTER},t.Destroy=function(){t.Collided&&(GAME_GLOBALS.AnimationManager.Add(new spritify({image:IMAGE_ASSETS.Explosion,centerOn:{X:t.CollidedAt.X,Y:t.CollidedAt.Y},frameCount:24,spriteSheetSize:{width:320,height:320},frameSize:{width:64,height:64},Rotation:t.MovementController.Rotation})),t.DamageDealt>0&&GAME_GLOBALS.AnimationManager.Add(new TextAnimation("-"+t.DamageDealt,t.CollidedAt.X,t.CollidedAt.Y,{duration:750}))),t.Visible=!1},t.Update=function(){var i=CalculatePOS(t.LastUpdated),r={X:i*t.MovementController.Velocity.X,Y:i*t.MovementController.Velocity.Y};t.MovementController.Position.X+=r.X,t.MovementController.Position.Y+=r.Y,t.MovementController.Position.X=Math.round(t.MovementController.Position.X),t.MovementController.Position.Y=Math.round(t.MovementController.Position.Y),t.LastUpdated=new Date},t.UpdateProperties(n),t.Draw(),t.LastUpdated=new Date};Bullet.prototype=new Collidable;function BulletManager(){var t=this;t.Bullets={},t.UpdateBullets=function(n){for(var f=n.length,u,i,r=0;r<f;r++)u=n[r],i=u.ID,t.Bullets[i]?t.Bullets[i].UpdateProperties(u):t.Bullets[i]=new Bullet(u),t.Bullets[i].Disposed?(t.Bullets[i].Destroy(),delete t.Bullets[i]):t.Bullets[i].Update()},t.Update=function(n){for(var i in t.Bullets)!CanvasContext.Camera.InView(t.Bullets[i])||t.Bullets[i].Disposed||t.Bullets[i].ShouldDispose()?(t.Bullets[i].Destroy(),delete t.Bullets[i]):(t.Bullets[i].Update(n),t.Bullets[i].Draw())}};function AbilityHandler(n){var i,t,r;if(n){for(i=this,t={},r=n.length-1;r>=0;r--)t[n[r].Name]=n[r];i.Abilities=function(){return t},i.Ability=function(n){return t[n]},i.AddAbility=function(n){t[n.Name]=n},i.Activate=function(n){return t[n]&&!t[n].Active?(t[n].Activate(),!0):!1},i.Deactivate=function(n){return t[n]&&t[n].Active?(t[n].Deactivate(),!0):!1},i.UpdateAbilities=function(n){var r,u,f;for(r in n)u=n[r],f=t[r].Active,u&&!f?i.Activate(r):!u&&f&&i.Deactivate(r)},i.Update=function(n){for(var i in t)t[i].Update(n)}}};function ShipAbilityHandler(n){if(n.MovementController){AbilityHandler.apply(this,[[new Boost(n.MovementController,n.Controllable)]]);var t=this;$(n).on("OnOutOfBounds",t.Ability("Boost").Deactivate)}}ShipAbilityHandler.prototype=new AbilityHandler;function Ability(n){if(n){var t=this;t.Active=!1,t.Name=n,t.ActivatedAt=!1,t.Activate=function(){t.Active=!0,t.ActivatedAt=+new Date},t.Deactivate=function(){t.ActivatedAt=!1,t.Active=!1}}};function MovementAbility(n,t){if(n&&t){Ability.apply(this,[n]);var i=this,r=t.Power;i.IncreaseSpeedBy=function(n){t.Power+=n},i.MultiplySpeedBy=function(n){t.Power*=n},i.DecreaseSpeedBy=function(n){t.Power-=n},i.ResetSpeed=function(){t.Power=r}}}MovementAbility.prototype=new Ability;function Boost(n,t){if(n){MovementAbility.apply(this,["Boost",n]);var i=this,r={};r.Activate=i.Activate,r.Deactivate=i.Deactivate,i.Activate=function(){i.MultiplySpeedBy(i.BOOST_SPEED_INCREASE),r.Activate(),t.Value=!1},i.Deactivate=function(){i.ResetSpeed(),r.Deactivate(),t.Value=!0},i.Update=function(n){i.Active&&n.getTime()-i.ActivatedAt>=i.BOOST_DURATION&&i.Deactivate()}}}Boost.prototype=new MovementAbility;function ShipMovementController(n){if(n){MovementController.apply(this,[this.MASS,this.ENGINE_POWER]);var t=this,i=new Vector2,r=["RotatingLeft","RotatingRight","Forward","Backward"];t.Position=n,t.Moving={},t.StopMovement=function(){for(var n=r.length-1;n>=0;n--)t.Moving[r[n]]=!1},t.StopMovement();function u(n,i){var u,r;t.Smoothing[n]&&(u=CalculatePO(t.LastUpdated,t.InterpolateOver[n]),t.Target[n]+=i[n],r=t.Target[n]-t.Position[n],t.Position[n]+=r*u,Math.abs(r)<=t.INTERPOLATE_POSITION_THRESHOLD&&(t.Smoothing[n]=!1))}function f(n){t.InterpolateOver&&(u("X",n),u("Y",n))}t.Move=function(n,r){var u,e=new Vector2,c=r.getTime();i=Vector2.AddV(i,Vector2.DivideVByN(t.Forces,t.Mass)),e=Vector2.AddV(Vector2.MultiplyN(t.Velocity,n),Vector2.MultiplyN(i,n*n)),t.Position=Vector2.AddV(t.Position,e),f(e),t.Velocity=Vector2.AddV(t.Velocity,Vector2.MultiplyN(i,n)),u=t.Velocity.Length(),u<10?t.Velocity.ZeroOut():u>3e3&&(t.Velocity=Vector2.MultiplyN(new Vector2(t.Rotation,!1),600)),i.ZeroOut(),t.Forces.ZeroOut();var o=n*t.ROTATE_SPEED,s=new Vector2(t.Rotation,!1),h=Vector2.MultiplyN(Vector2.MultiplyV(Vector2.MultiplyN(t.Velocity,.5),t.Velocity.Abs()),t.DRAG_COEFFICIENT*t.DRAG_AREA*-1);t.Moving.RotatingLeft&&(t.Rotation-=o),t.Moving.RotatingRight&&(t.Rotation+=o),t.Moving.Forward&&t.ApplyForce(Vector2.MultiplyN(s,t.Power)),t.Moving.Backward&&t.ApplyForce(Vector2.MultiplyN(s,t.Power*-1)),t.ApplyForce(h),t.Position.X=Math.round(t.Position.X),t.Position.Y=Math.round(t.Position.Y)},t.Update=function(n,i){t.Move(n,i),t.LastUpdated=i},t.UpdateMovementController=function(n){t.Forces.X=n.Forces.X,t.Forces.Y=n.Forces.Y,t.Mass=n.Mass;for(var i=r.length-1;i>=0;i--)t.Moving[r[i]]=n.Moving[r[i]];t.Position.X=n.Position.X,t.Position.Y=n.Position.Y,t.Rotation=n.Rotation,t.Velocity.X=n.Velocity.X,t.Velocity.Y=n.Velocity.Y}}}ShipMovementController.prototype=new MovementController;function ShipManager(n){var t=this;t.DrawDetails=!0,t.Ships={},t.MyShip,t.ForcedVehicle=!1,t.InitializeMyShip=function(i,r){t.MyShip=new Ship(["a","left"],["w","up"],["d","right"],["s","down"],"Space",i,r),t.MyShip.ID=n,t.Ships[n]=t.MyShip},t.RemoveShip=function(n){t.Ships[n].Destroy(),delete t.Ships[n]},t.UpdateShips=function(n){for(var s=n.length,i,r,f,e,o,u=0;u<s;u++)i=n[u],r=i.ID,i.Visible=!0,f=Math.min(i.Level,10),i.Vehicle=t.ForcedVehicle?t.ForcedVehicle:IMAGE_ASSETS["Ship"+f],i.GUID=i.ID,e=i.Abilities,o=i.MovementController,delete i.Abilities,delete i.MovementController,t.Ships[r]?t.Ships[r].UpdateProperties(i):t.Ships[r]=new ShipVehicle(i),t.Ships[r].ShipAbilityHandler.UpdateAbilities(e),t.Ships[r].MovementController.UpdateMovementController(o),t.Ships[r].Disposed?(t.Ships[r].Destroy(),r!==t.MyShip.ID?t.RemoveShip(r):t.Ships[r].LifeController.Alive||(t.SmoothX=!1,t.SmoothY=!1)):t.Ships[r].Update()},t.Update=function(i){var u=t.Ships[n],r;u&&(u.Update(i),u.Draw());for(r in t.Ships)CanvasContext.Camera.InView(t.Ships[r])&&n!==t.Ships[r].ID?(t.Ships[r].Update(i),t.Ships[r].Draw(),t.Ships[r].LifeController.Alive&&t.DrawDetails&&(t.Ships[r].DrawHealthBar(),t.Ships[r].DrawName(10))):n!==t.Ships[r].ID&&delete t.Ships[r]}};function ShipAnimationHandler(n){var o=this,i,t,r,u,h=400,s=200,f=s/2,e;n.InitializeAnimationCanvas(),n.UpdateAnimationCanvasSize({Width:n.WIDTH+s,Height:n.HEIGHT}),r=new spritify({image:IMAGE_ASSETS.Boost,drawOn:n.AnimationCanvasContext,X:0,Y:n.HEIGHT/2-26,frameCount:10,fps:12,spriteSheetSize:{width:400,height:150},frameSize:{width:100,height:50},Rotation:0,autoPlay:!1,autoClear:!1,loop:!0,loopFrom:4,finalFrames:2}),i=new spritify({image:IMAGE_ASSETS.ThrustBasic,drawOn:n.AnimationCanvasContext,X:50,Y:n.HEIGHT/2-25,frameCount:18,fps:18,spriteSheetSize:{width:450,height:100},frameSize:{width:50,height:50},Rotation:0,autoPlay:!1,autoClear:!1,loop:!0}),t=new spritify({image:IMAGE_ASSETS.ThrustStart,drawOn:n.AnimationCanvasContext,X:50,Y:n.HEIGHT/2-25,frameCount:18,fps:18,spriteSheetSize:{width:450,height:100},frameSize:{width:50,height:50},Rotation:0,autoPlay:!1,autoClear:!1,loop:!0}),n.AnimationDrawList.push(i),n.AnimationDrawList.push(t),n.AnimationDrawList.push(r),e=n.MaxLife,o.DrawDamage=function(){var r=e-n.LifeController.Health,t,i;if(r!==0)if(e=n.LifeController.Health,t=Math.floor((1-n.LifeController.Health/n.MaxLife)*10)-2,t>0&&t<8)if(r<0)for(n.AnimationCanvasContext.clearRect(f,0,n.WIDTH,n.HEIGHT),i=1;i<=t;i++)IMAGE_ASSETS["ShipDamage"+i]&&n.AnimationCanvasContext.drawImage(IMAGE_ASSETS["ShipDamage"+i],f,0);else IMAGE_ASSETS["ShipDamage"+t]&&n.AnimationCanvasContext.drawImage(IMAGE_ASSETS["ShipDamage"+t],f,0);else n.AnimationCanvasContext.clearRect(f,0,n.WIDTH,n.HEIGHT)},o.Update=function(f){var e=f.getTime();n.ShipAbilityHandler.Ability("Boost").Active?(r.Play(),i.Stop(),t.Stop()):(r.Stop(!0),n.MovementController.Moving.Forward?(u||(u=+new Date),e-u>=h&&i.Play(),t.Play()):(u=!1,i.Stop(),t.Stop()),i.Update(f),t.Update(f)),r.Update(f),r.ClearDrawOnCanvas(),t.ClearDrawOnCanvas()}};function ShipVehicle(n){var t,i,f,e,o,r,u;Collidable.call(this),t=this,t.AnimationHandler=new ShipAnimationHandler(t),t.MovementController=new ShipMovementController(new Vector2),t.Vehicle=IMAGE_ASSETS.Ship1,t.Destroy=function(){t.LifeController.Alive||GAME_GLOBALS.AnimationManager.Add(new spritify({image:IMAGE_ASSETS.BigExplosion,centerOn:{X:t.MovementController.Position.X+t.HALF_WIDTH,Y:t.MovementController.Position.Y+t.HALF_HEIGHT},frameCount:30,fps:25,spriteSheetSize:{width:768,height:640},frameSize:{width:128,height:128},Rotation:t.MovementController.Rotation})),t.Visible=!1},t.Update=function(){var i=CalculatePOS(t.LastUpdated);t.UpdateFromSecond(i)},t.UpdateFromSecond=function(n){var i=new Date;t.MovementController.Update(n,i),t.AnimationHandler.Update(i),t.AnimationHandler.DrawDamage(),t.ShipAbilityHandler.Update(i),t.LastUpdated=i},i=t.WIDTH*.8,f=(t.WIDTH-i)*.5,t.DrawHealthBar=function(){o!==t.LifeController.Health&&(r=t.LifeController.Health/t.MaxLife,e=i*r,o=t.LifeController.Health,u=r<=HealthMonitor.prototype.BadThreshold?GAME_GLOBALS.Colors.ShipBad:r<=HealthMonitor.prototype.HurtThreshold?GAME_GLOBALS.Colors.ShipHurt:GAME_GLOBALS.Colors.ShipGood),CanvasContext.drawRectangle(t.MovementController.Position.X+f,t.MovementController.Position.Y+t.HEIGHT+15,i,5,"#7F767D"),CanvasContext.drawRectangle(t.MovementController.Position.X+f,t.MovementController.Position.Y+t.HEIGHT+15,e,5,u)},t.DrawName=function(n){CanvasContext.drawText(t.Name,t.MovementController.Position.X+t.HALF_WIDTH,t.MovementController.Position.Y+t.HEIGHT+30+n)},t.DrawBoundary=function(){CanvasContext.strokeSquare(t.MovementController.Position.X,t.MovementController.Position.Y,t.WIDTH,t.HEIGHT)},t.UpdateProperties(n),t.ShipAbilityHandler=new ShipAbilityHandler(this)}ShipVehicle.prototype=new Collidable;function Ship(n,t,i,r,u,f,e){function et(){var n=+new Date;w&&(p=n-w),w=n}function nt(n,t,i){i[t]>o.MovementController.INTERPOLATE_POSITION_THRESHOLD&&(o.MovementController.InterpolateOver[t]=Math.max(p,50),o.MovementController.Smoothing[t]=!0,o.MovementController.Target[t]=n.MovementController.Position[t],n.MovementController.Position[t]=o.MovementController.Position[t])}function ot(n){var t=Math.abs(o.MovementController.Rotation-n.MovementController.Rotation);t>o.MovementController.INTERPOLATE_ROTATION_THRESHOLD&&(o.MovementController.InterpolateRotationOver=Math.max(p,35),o.MovementController.SmoothingRotation=!0,o.MovementController.TargetRotation=n.MovementController.Rotation,n.MovementController.Rotation=o.MovementController.Rotation)}function st(n){if(p){if(o.LifeController.Alive||(o.MovementController.Smoothing.X=!1,o.MovementController.Smoothing.Y=!1,d=!0),!d){if(o.TryInterpolate){o.Update();var t=CalculateDistance(o.MovementController.Position,n.MovementController.Position);nt(n,"X",t),nt(n,"Y",t)}o.TryInterpolateRotation&&ot(n)}o.LifeController.Alive&&(d=!1)}}function tt(n){return n==="Forward"?(ht("Boost"),!0):!1}function ht(n){o.Controllable.Value&&o.ShipAbilityHandler.Activate(n)&&o.LifeController.Alive&&(s.push([++h,n,!0,!0]),e.server.registerAbilityStart(n,!1,h),o.UpdateFromSecond(CalculatePOS(o.LastUpdated)))}function it(n){var t,i,r;o.Controllable.Value&&!o.MovementController.Moving[n]&&o.LifeController.Alive&&(t=!1,i=+new Date,c=++c%o.REQUEST_PING_EVERY,c===0&&(t=!0,o.LatencyResolver.RequestedPingBack()),r=!1,i-y<=g&&v===n&&(r=tt(n)),r||(y=i,v=n,s.push([++h,n,!0]),e.server.registerMoveStart(n,t,h),o.UpdateFromSecond(CalculatePOS(o.LastUpdated)),o.MovementController.Moving[n]=!0))}function rt(n){if(o.Controllable.Value&&o.LifeController.Alive){var t=!1;c=++c%o.REQUEST_PING_EVERY,c===0&&(t=!0,o.LatencyResolver.RequestedPingBack()),s.push([++h,n,!1]),e.server.registerMoveStop(n,t,h),o.UpdateFromSecond(CalculatePOS(o.LastUpdated)),o.MovementController.Moving[n]=!1}}function ct(n,t){var i,r,u;o.Controllable.Value&&o.LifeController.Alive&&(i=!1,r=+new Date,c=++c%o.REQUEST_PING_EVERY,c===0&&(i=!0,o.LatencyResolver.RequestedPingBack()),u=!1,r-y<=g&&v===t&&(u=tt(t)),u||(y=r,v=t,s.push([++h,n,!1]),s.push([++h,t,!0]),e.server.startAndStopMovement(n,t,i,h),o.UpdateFromSecond(CalculatePOS(o.LastUpdated)),o.MovementController.Moving[n]=!1,o.MovementController.Moving[t]=!0))}function ut(n){var i,t;if(o.Controllable.Value&&o.LifeController.Alive){for(i=!1,c=++c%o.REQUEST_PING_EVERY,c===0&&(i=!0),o.UpdateFromSecond(CalculatePOS(o.LastUpdated)),t=0;t<n.length;t++)o.MovementController.Moving[n[t]]=!1,s.push([++h,n[t],!1]);e.server.resetMovement(n,i,h)}}function ft(n){var t=n-b;o.Controllable.Value&&t>o.MIN_FIRE_RATE&&(b=n,e.server.fire())}function lt(){var t,n=!0,i;for(k=0;k<l.length;k++)for(z=0;z<l[k].key.length;z++)shortcut.add(l[k].key[z],function(n){return function(){it(l[n].dir)}}(k),{disable_in_input:!0,type:"keydown"}),shortcut.add(l[k].key[z],function(n){return function(){rt(l[n].dir)}}(k),{disable_in_input:!0,type:"keyup"});shortcut.add(u,function(){t=+new Date,n?(ft(t),i=setTimeout(function(){n=!1,e.server.startFire()},o.MIN_FIRE_RATE)):e.server.startFire()},{disable_in_input:!0,type:"keydown"}),shortcut.add(u,function(){var r;clearTimeout(i),r=+new Date,n||(b=r,e.server.stopFire()),n=r-t<o.MIN_FIRE_RATE},{disable_in_input:!0,type:"keyup"}),$(window).blur(function(){ut(["Forward","Backward","RotatingLeft","RotatingRight"]),e.server.stopFire()})}ShipVehicle.call(this);var o=this,b=+new Date,l=[],c=o.REQUEST_PING_EVERY,a,s=[],h=0,w,p,y=+new Date,v,d=!1,g=175;l.push({key:n,dir:"RotatingLeft"}),l.push({key:i,dir:"RotatingRight"}),l.push({key:t,dir:"Forward"}),l.push({key:r,dir:"Backward"}),o.REQUEST_PING_EVERY,o.MovementController.INTERPOLATE_POSITION_THRESHOLD=4,o.MovementController.INTERPOLATE_ROTATION_THRESHOLD=15,o.LatencyResolver,o.MovementController.Smoothing={X:!1,Y:!1},o.MovementController.Target={X:0,Y:0},o.MovementController.InterpolateOver={X:0,Y:0},o.MovementController.InterpolateRotationOver,o.MovementController.SmoothingRotation=!1,o.MovementController.TargetRotation,o.TryInterpolate=!0,o.TryInterpolateRotation=!1,o.LifeController={Health:o.MaxLife},o.PayloadReceived=function(n){et();for(var t=0;t<n.Ships.length;t++)if(o.ID===n.Ships[t].ID){st(n.Ships[t]);break}},lt(),o.ReplayCommands=function(n){var i,t;if(s.length>=1){for(i=s.length-(h-n),t=i;t<s.length;t++)s[t][3]?s[t][2]?o.ShipAbilityHandler.Activate(s[t][1]):o.ShipAbilityHandler.Deactivate(s[t][1]):o.MovementController.Moving[s[t][1]]=s[t][2];s.splice(0,i)}},o.Initialize=function(n){("createTouch"in document||navigator.msMaxTouchPoints)&&(a=new TouchController(it,rt,ct,ut,ft),a.Initialize(n))},o.DrawHUD=function(){a&&a.Draw()},o.ResetTouchController=function(){a&&a.Reset()}};function PayloadDecompressor(){function o(t){return{Collided:!!t[n.Collided],CollidedAt:{X:t[n.CollidedAtX],Y:t[n.CollidedAtY]},MovementController:{Forces:{X:t[n.ForcesX],Y:t[n.ForcesY]},Mass:t[n.Mass],Position:{X:t[n.PositionX],Y:t[n.PositionY]},Rotation:t[n.Rotation],Velocity:{X:t[n.VelocityX],Y:t[n.VelocityY]}},LifeController:{Alive:t[n.Alive],Health:t[n.Health]},ID:t[n.ID],Disposed:!!t[n.Disposed]}}function s(n){var t=o(n);return t.MovementController.Moving={RotatingLeft:!!n[r.RotatingLeft],RotatingRight:!!n[r.RotatingRight],Forward:!!n[r.Forward],Backward:!!n[r.Backward]},t.Name=n[r.Name],t.MaxLife=n[r.MaxLife],t.Level=n[r.Level],t.Abilities={Boost:n[r.Boost]},t}function h(n){var t=o(n);return t.DamageDealt=n[e.DamageDealt],t}function c(n){return{Ships:n[t.Ships],LeaderboardPosition:n[t.LeaderboardPosition],Kills:n[t.Kills],Deaths:n[t.Deaths],Powerups:n[t.Powerups],Bullets:n[t.Bullets],ShipsInWorld:n[t.ShipsInWorld],BulletsInWorld:n[t.BulletsInWorld],Experience:n[t.Experience],ExperienceToNextLevel:n[t.ExperienceToNextLevel],Notification:n[t.Notification],LastCommandProcessed:n[t.LastCommandProcessed],KilledByName:n[t.KilledByName],KilledByPhoto:n[t.KilledByPhoto]}}function l(n){return{Name:n[LeaderboardEntryContract.Name],Photo:n[LeaderboardEntryContract.Photo],ID:n[LeaderboardEntryContract.ID],Level:n[LeaderboardEntryContract.Level],Kills:n[LeaderboardEntryContract.Kills],Deaths:n[LeaderboardEntryContract.Deaths]}}function a(n){return{MovementController:{Position:{X:n[u.PositionX],Y:n[u.PositionY]},Rotation:0},ID:n[u.ID],Disposed:n[u.Disposed],Type:n[u.Type],LifeController:{Alive:!0}}}var f=this,t,n,r,e,u;f.LoadContracts=function(i){t=i.PayloadContract,n=i.CollidableContract,r=i.ShipContract,e=i.BulletContract,LeaderboardEntryContract=i.LeaderboardEntryContract,u=i.PowerupContract},f.Decompress=function(n){for(var i=c(n),r=i.Ships.length,u=i.Bullets.length,f=i.Powerups.length,t=0,t=0;t<r;t++)i.Ships[t]=s(i.Ships[t]);for(t=0;t<u;t++)i.Bullets[t]=h(i.Bullets[t]);for(t=0;t<f;t++)i.Powerups[t]=a(i.Powerups[t]);return i},f.DecompressLeaderboard=function(n){var r=[],u=n.length,t;for(i=0;i<u;i++)t=l(n[i]),t.Position=i+1,r.push(t);return r}};function ConfigurationManager(n){var t=this;$.extend(ShipVehicle.prototype,n.shipConfig),$.extend(ShipMovementController.prototype,n.shipMovementControllerConfig),$.extend(Ability.prototype,n.abilityConfig),ShipVehicle.prototype.HALF_WIDTH=ShipVehicle.prototype.WIDTH*.5,ShipVehicle.prototype.HALF_HEIGHT=ShipVehicle.prototype.HEIGHT*.5,Bullet.prototype.BULLET_DIE_AFTER=n.gameConfig.BULLET_DIE_AFTER,$.extend(Leaderboard.prototype,n.leaderboardConfig),$.extend(Bullet.prototype,n.bulletConfig),$.extend(Map.prototype,n.mapConfig),$.extend(Screen.prototype,n.screenConfig),$.extend(Game.prototype,n.gameConfig),$.extend(HealthPack.prototype,n.healthPackConfig),DeathScreen.prototype.RESPAWN_TIMER=n.gameConfig.RESPAWN_TIMER,Camera.prototype.View={SPEED:n.gameConfig.MAX_CAMERA_SPEED},ShipVehicle.prototype.REQUEST_PING_EVERY=n.gameConfig.REQUEST_PING_EVERY,$.extend(t,n),ApplyInheritance()}function ApplyInheritance(){Ship.prototype=new ShipVehicle};function Game(n,t,i){var r=this,f=new Map,u;r.GameTime=new GameTime,r.BulletManager=new BulletManager,r.ShipManager=new ShipManager(i,r.GameTime),r.ShipManager.InitializeMyShip(r.BulletManager,n),r.PowerupManager=new PowerupManager,u=r.ShipManager.MyShip,CanvasContext.Camera.Follow(u),r.HUDManager=new HUDManager(u,n),r.Update=function(n){r.GameTime.Update(),CanvasContext.clear(),f.CheckBoundaryCollisions(r.ShipManager.Ships,r.BulletManager.Bullets),r.HUDManager.Update(n),r.ShipManager.Update(r.GameTime),r.PowerupManager.Update(r.GameTime),r.BulletManager.Update(r.GameTime),GAME_GLOBALS.AnimationManager.Update(r.GameTime),f.Draw(),r.ShipManager.MyShip.DrawHUD(),CanvasContext.Render()}};var NotificationManager=function(){function n(){this.controlsNCredits=$("#ControlsNCredits"),this.showInfoButton=$("#ShowInfo"),this.controlsNCreditsHeight=$("#ControlsNCredits").height(),this.notificationHolder=$("#NotificationHolder"),this.notificationHalfHeight=50,this.notificationBase=$(".Notification"),this.notificationBaseHeight=$(".Notification").height()+parseInt($(".Notification").css("margin-bottom")),this.notifications=$("#Notifications"),this.initialControlsShowFor=7e3,this.notifyTime=4e3;var n=this;this.showInfoButton.click(function(){var t=$(this);t.hasClass("active")?(n.hideInfo(),$(this).removeClass("active")):(n.showInfo(),$(this).addClass("active"))}),this.showInfoButton.click(),setTimeout(function(){n.showInfoButton.hasClass("active")&&n.showInfoButton.click()},this.initialControlsShowFor)}return n.prototype.showInfo=function(){this.notificationHolder.css("display","block"),this.notificationHolder.css("top",parseInt(this.notificationHolder.css("top"))-this.controlsNCreditsHeight),this.controlsNCredits.fadeIn(1e3)},n.prototype.hideInfo=function(){var n=this;this.controlsNCredits.fadeOut(1e3,function(){n.notificationHolder.css("top",parseInt(n.notificationHolder.css("top"))+n.controlsNCreditsHeight),n.notificationHolder.css("display","none")})},n.prototype.Notify=function(n,t){var i=this.notificationBase.clone(),u=i.find("p"),r=this,f;u.html(n),this.notifications.append(i),this.notificationHolder.css("display","block"),this.notificationHolder.css("top",parseInt(this.notificationHolder.css("top"))-this.notificationBaseHeight),i.fadeIn(1e3,function(){t||setTimeout(function(){i.fadeOut(1e3,function(){i.remove(),r.notificationHolder.css("top",parseInt(r.notificationHolder.css("top"))+r.notificationBaseHeight),r.notificationHolder.css("display","none")})},r.notifyTime)}),f=u.height()/2,u.css("top",this.notificationHalfHeight-f)},n}();function EnvironmentMonitor(n){var t=this,i=$("#Latency"),r=$("#WorldTargets"),u=$("#WorldBullets"),f=$("#Area"),e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];t.Update=function(t){var f=Map.prototype.WIDTH,e=Math.max(Math.round(f/26),1e3);i.html(n.LatencyResolver.Latency),u.html(t.BulletsInWorld),r.html(t.ShipsInWorld)}};function ShipStatMonitor(n){var t=this,i=$("#Speed"),r=$("#IncreasedHealth"),u=$("#IncreasedDamage");t.Update=function(){var t=Math.round(Math.sqrt(Math.pow(n.MovementController.Velocity.X,2)+Math.pow(n.MovementController.Velocity.Y,2))),f=n.MaxLife-n.START_LIFE,e=Math.round((n.Level-1)*n.DAMAGE_INCREASE_RATE*10)/10;i.html(t),r.html(f),u.html(e)}};function HealthMonitor(n){var r=this,f=n.START_LIFE,t=n.Health,o=$("#Health"),i=$("#HealthHeart"),s=$("#WhiteHealthHeart"),c=$("#HealthHolder"),l=$("#HealthText"),u=500,a=$("#gameWrapper"),h=.5*i.width(),e=!0;r.OnScreenResize=function(){t=-1,r.Update(!0)},r.Update=function(a){var p,w;if(n.LifeController.Health!==t){f=n.MaxLife,n.LifeController.Health<t?(p=n.LifeController.Health-t,p===0||a||GAME_GLOBALS.AnimationManager.Add(new TextAnimation(p,n.MovementController.Position.X+.5*n.WIDTH,n.MovementController.Position.Y-1.5*n.HEIGHT,{duration:2e3,color:[237,30,121],fontSize:"36px SegoeUISemibold"})),n.LifeController.Health<=0&&(s.fadeOut(u),e=!1)):e?(w=n.LifeController.Health-t,w>0&&!a&&GAME_GLOBALS.AnimationManager.Add(new TextAnimation("+"+w,n.MovementController.Position.X+.5*n.WIDTH,n.MovementController.Position.Y-1.5*n.HEIGHT,{duration:2e3,color:[122,201,67],fontSize:"36px SegoeUISemibold"}))):(e=!0,s.fadeIn(u)),t=n.LifeController.Health,l.html(t+"/"+f),o.stop(!0),i.stop(!0);var v=t/f,b=c.width(),k=Math.min(Math.max(b*v-h,0),b-2*h),y;i.removeClass("good hurt bad"),v<=r.BadThreshold?(i.addClass("bad"),y=GAME_GLOBALS.Colors.ShipBad):v<=r.HurtThreshold?(i.addClass("hurt"),y=GAME_GLOBALS.Colors.ShipHurt):(i.addClass("good"),y=GAME_GLOBALS.Colors.ShipGood),i.animate({left:k},u,"easeOutExpo"),o.animate({width:v*100+"%",backgroundColor:y},u,"easeOutExpo")}}}HealthMonitor.prototype.BadThreshold=.3,HealthMonitor.prototype.HurtThreshold=.6;function DeathScreen(n,t){var f=this,r=[["HAS LEFT A DENT IN YOUR EGO.","(HOPE NOBODY SAW THAT)"],["JUST DOMINATED YOU.","OUCH!"],["SUCKS TO BE YOU!",""],["...","REALLY?"],["YOU ALRIGHT?","THAT MUST HAVE HURT."],["SAID TO TELL YOUR MOTHER","HELLO!"],["TIS BUT A SCRATCH",""],["BOOM...","HEADSHOT!"],["CAN'T LET YOU DO THAT STARFOX",""],["PLAYTIME IS OVER!",""],["YOU MISSED!","YOU MAY NEED GLASSES"],["YOU'RE GOOD...","BUT I'M BETTER."],["TOO SLOW...","MY GRAMAH DRIVES FASTER THAN THAT!"],["TOASTERS...","BLAME THE TOASTERS!"],["=(",""]],a=$("#game"),e=$("#HUDBarCover, #GameCover, #popUpHolder"),u=$("#RespawnTime"),s=$("#KilledByNameSmall, #KilledByNameLarge"),h=$("#KilledByPhotoSmall, #KilledByPhotoLarge"),o=$("#doublePopupHolder"),i=$("#leaderboardHolder, #deathScreenHolder"),c=$("#topLineQuote"),l=$("#botLineQuote");f.YouDied=function(n,a){var v=Math.floor(Math.random()*r.length),y;t.ResetTouchController(),c.html(r[v][0]),l.html(r[v][1]),s.html(n),h.attr("src",a),i.css("display","block"),o.css("display","block"),i.addClass("goLeft"),e.fadeIn(1e3),u.html(f.RESPAWN_TIMER),y=setInterval(function(){var n=parseInt(u.html())-1;u.html(n),n===0&&(clearInterval(y),e.fadeOut(1e3,function(){i.css("display","none"),o.css("display","none"),i.removeClass("goLeft")}))},1e3)}};function MyRankings(){var e=this,n=!1,t=$("#GlobalRanking"),s=$("#GlobalRankingLB"),i=$("#Kills"),r=$("#Deaths"),h=$("#KDRatio"),u,f,o;e.LoadPosition=function(i,r){(n!=i||r!==o)&&(n&&n!=i&&(t.stop(!0),t.animate({color:"#FFFFFF"},500).animate({color:"#7F7F7F"},500)),n=i,o=r,t.html(n),s.html(n+" of "+r))},e.Update=function(n,t){var e,o,s;(n!=u||t!=f)&&(n!=u&&(i.stop(!0),i.animate({color:"#7F7F7F"},500).animate({color:"#FFFFFF"},500),i.html(n)),t!=f&&(r.stop(!0),r.animate({color:"#7F7F7F"},500).animate({color:"#FFFFFF"},500),r.html(t)),t===0&&n!==0?e="∞":t===0&&n===0?e="":(n<=t&&n!==0?(o=1,s=Math.round(t/n*10)/10):(o=Math.round(n/t*10)/10,s=1),e=o+":"+s),h.html(e),u=n,f=t)}};function ExperienceMonitor(n,t){var h=this,i=t.Experience,r=1,e=t.ExperienceToNextLevel,u=$("#Experience"),o=$("#ExperienceBar"),f=500,c=$("#Level"),l=$("#levelNotification"),a=$("#CurrentLevel_Notification"),s=$("#popUpHolder");h.Update=function(){if(t.Experience!==i||t.Level!==r){var n,h;t.Level!==r?(n=e-i+t.Experience,o.css("width","0%"),s.css("display","block"),a.html(t.Level),l.animate({top:0},1e3).delay(3e3).animate({top:-234},1e3,function(){s.css("display","none")})):n=t.Experience-i,u.html(t.Experience+"/"+t.ExperienceToNextLevel),h=t.Experience/t.ExperienceToNextLevel*100,n===0||isNaN(n)||GAME_GLOBALS.AnimationManager.Add(new TextAnimation(n>0?"+"+n:n,t.MovementController.Position.X,t.MovementController.Position.Y,{duration:2e3,color:[250,182,250]})),u.stop(!0),u.animate({color:"#FFFFFF"},f).animate({color:"#7F7F7F"},f),o.animate({width:h+"%"},f,"easeOutExpo"),r=t.Level,i=t.Experience,e=t.ExperienceToNextLevel,c.html(t.Level)}}};function Leaderboard(n,t,i){function w(n){for(var r,u,e,i=0;i<n.length;i++){r=$(f[i]),n[i].ID===t.ID?(n[i].Photo.length===0&&(n[i].Photo="Images/HUD/You_Default.png"),r.addClass("highlight")):r.removeClass("highlight"),u=r.find(".lbPhoto"),n[i].Photo.length===0&&(n[i].Photo="Images/HUD/KilledBy_Default.png"),u.attr("src")!==n[i].Photo&&u.attr("src",n[i].Photo),delete n[i].Photo,delete n[i].ID;for(e in n[i])r.find(".lb"+e).html(n[i][e])}}function v(){shortcut.add("Tab",function(){a()},{disable_in_input:!0}),$("#GlobalRanking").click(function(){a()})}function a(){r.LeaderboardUp?y():p()}function p(){u.hasClass("goLeft")||(r.LeaderboardUp=!0,h.css("display","block"),c.fadeIn(350),l.fadeIn(350),i.server.readyForLeaderboardPayloads())}function y(){u.hasClass("goLeft")||(r.LeaderboardUp=!1,c.fadeOut(200,function(){h.css("display","none")}),l.fadeOut(200),i.server.stopLeaderboardPayloads())}var r=this,h=$("#leaderboardHolder, #doublePopupHolder"),u=$("#leaderboard"),c=$("#popUpHolder"),l=$("#GameCover"),b=$("#myRanking"),f=[],e,o,s;for(r.LeaderboardUp=!1,e=$("#leaderboard .row"),f.push(e),o=0;o<r.LEADERBOARD_SIZE-1;o++)s=e.clone(),f.push(s),u.append(s);v(),r.Load=function(n){w(n)}};function GameDetailManager(){function n(){shortcut.add("X",function(){GAME_GLOBALS.Game.ShipManager.DrawDetails=!GAME_GLOBALS.Game.ShipManager.DrawDetails},{disable_in_input:!0,type:"keyup"})}var t=this;n()};function HUDManager(n,t){function s(n){f.css("top",(n.Height-u)/2-f.height()/2)}var i=this,r=$("#gameHUD"),f=$("#doublePopupHolder"),u=r.height(),e=$("#LocationStatisticsHolder"),o=$("#StatisticHolder");i.GameDetailManager,i.HealthMonitor=new HealthMonitor(n),i.ExperienceMonitor=new ExperienceMonitor(r,n),i.MyRankings=new MyRankings,i.Leaderboard=new Leaderboard(r,n,t),i.DeathScreen=new DeathScreen(i.Leaderboard,n),i.ShipStatMonitor=new ShipStatMonitor(n),i.EnvironmentMonitor=new EnvironmentMonitor(n),i.NotificationManager=new NotificationManager,i.AreaRenderer=new AreaRenderer(n,Map.prototype.WIDTH),i.OnMapResize=function(n){i.AreaRenderer.OnMapResize(n.Width)},i.OnScreenResize=function(n){r.css("width",n.Width),r.css("height",u),r.css("top",n.Height-u),i.HealthMonitor.OnScreenResize(),s(n),n.Width<=1370?e.css("display","none"):e.css("display","block"),n.Width<=1177?o.css("display","none"):o.css("display","block")},i.Initialize=function(){i.GameDetailManager=new GameDetailManager},i.Update=function(n){i.HealthMonitor.Update(),i.ExperienceMonitor.Update(),i.MyRankings.Update(n.Kills,n.Deaths),i.ShipStatMonitor.Update(),i.EnvironmentMonitor.Update(n),i.AreaRenderer.Update()}};function TextAnimation(n,t,i,r){var u=this,f=1,e=+new Date;r=$.extend({duration:500,color:[255,0,0],fontSize:"17px SegoeUISemibold"},r),u.Destroyed=!1,u.Draw=function(){f=1-(+new Date-e)/r.duration,CanvasContext.drawText(n,t,i,"rgba("+r.color[0]+","+r.color[1]+","+r.color[2]+","+f+")",r.fontSize),f<=0&&(u.Destroyed=!0)}};$(function(){function a(i){i!=null?(e=new ConfigurationManager(i.Configuration),n=new Game(t,f,i.ShipID),GAME_GLOBALS.Game=n,u.LoadContracts(i.CompressionContracts),n.HUDManager.Initialize(i),o.Initialize(n.HUDManager),n.ShipManager.MyShip.LatencyResolver=f,n.ShipManager.MyShip.Initialize(o),v(),t.server.readyForPayloads()):alert("Refresh your page")}function v(){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,e.gameConfig.UPDATE_INTERVAL)}}(),function t(){requestAnimFrame(t),s&&n.Update(h)}()}function y(t){var i=n.ShipManager.MyShip;t.ShipsOnScreen=n.ShipManager.Ships,h=t,t.Notification&&n.HUDManager.NotificationManager.Notify(t.Notification,!1),t.KilledByName&&n.HUDManager.DeathScreen.YouDied(t.KilledByName,t.KilledByPhoto),i.Experience=t.Experience,i.ExperienceToNextLevel=t.ExperienceToNextLevel,n.HUDManager.MyRankings.LoadPosition(t.LeaderboardPosition,t.ShipsInWorld),n.ShipManager.MyShip.PayloadReceived(t),n.ShipManager.UpdateShips(t.Ships),n.PowerupManager.UpdatePowerups(t.Powerups,n.GameTime),n.ShipManager.MyShip.ReplayCommands(t.LastCommandProcessed),n.BulletManager.UpdateBullets(t.Bullets),s=!0}var t=$.connection.h,n,e,u=new PayloadDecompressor,f=new LatencyResolver(t),o=new Screen($("#game"),$("#gameWrapper"),$("#popUpHolder"),t),p=$("#Notification"),s=!1,h={Ships:{},Bullets:[]},c=$.cookie("shootr.state"),i=c?JSON.parse(c):{},l=i.RegistrationID,r;t.client.d=function(n){y(u.Decompress(n))},t.client.l=function(t){n.HUDManager.Leaderboard.Load(u.DecompressLeaderboard(t))},t.client.mapSizeIncreased=function(t){Map.prototype.WIDTH=t.Width,Map.prototype.HEIGHT=t.Height,n.HUDManager.OnMapResize(t)},t.client.notify=function(n){alert(n)},t.client.disconnect=function(){n.HUDManager.NotificationManager.Notify("You have been disconnected for being Idle too long.  Refresh the page to play again.",!0),$.connection.hub.stop()},t.client.controlTransferred=function(){n.HUDManager.NotificationManager.Notify("You have been disconnected!  The control for your ship has been transferred to your other login.",!0),$.connection.hub.stop()},r=!1,t.client.bindLaserCat=function(){shortcut.add("9",function(){r?t.server.deactivateLaserCatBomb():t.server.activateLaserCatBomb()})},t.client.laserCatBomb=function(t){t?(r=!0,n.ShipManager.ForcedVehicle=IMAGE_ASSETS.LaserCatBomb):(r=!1,n.ShipManager.ForcedVehicle=!1)},t.client.pingBack=f.ServerPingBack,l&&(delete i.RegistrationID,$("#DisplayName").html(i.DisplayName),$("#DisplayNameLB").html(i.DisplayName),$("#You").attr("src",i.Photo),$("#YouLB").attr("src",i.Photo),$.cookie("shootr.state",JSON.stringify(i),{path:"/",expires:30}),$.connection.hub.start(function(){t.server.initializeClient(l).done(function(n){a(n)})})),$("#logout").click(function(){for(var t=document.cookie.split(";"),i,r,n=0;n<t.length;n++)i=t[n].indexOf("="),r=i>-1?t[n].substr(0,i):t[n],document.cookie=r+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT";window.location.href=window.location.href})});